from __future__ import annotations

import logging
from sqlalchemy.ext.asyncio import AsyncSession

from app.db import SessionMaker
from app.repositories.bot_texts import BotTextRepo

log = logging.getLogger(__name__)


DEFAULT_TEXTS: dict[str, str] = {
    "welcome": (
        "–ü—Ä–∏–≤–µ—Ç! üëã\n\n"
        "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ email, –∫–æ—Ç–æ—Ä—ã–π –í—ã —É–∫–∞–∑–∞–ª–∏ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É.\n\n"
        "–í–∞–∂–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ –ø–∏—Å—å–º–µ (–∫–Ω–æ–ø–∫–∞/—Å—Å—ã–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)."
    ),
    "check_again_prompt": "–û–∫! –ü—Ä–∏—à–ª–∏—Ç–µ email –µ—â—ë —Ä–∞–∑ (–∏–ª–∏ —Ç–æ—Ç –∂–µ).",
    "telegram_id_missing": "–ù–µ —Å–º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –í–∞—à Telegram ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
    "invalid_email": "–ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ email. –ü—Ä–∏—à–ª–∏—Ç–µ –∞–¥—Ä–µ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ name@example.com",
    "unisender_unavailable": "–°–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.",
    "not_confirmed_invited": (
        "‚ùó –ü–æ–¥–ø–∏—Å–∫–∞ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.\n"
        "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É: –æ—Ç–∫—Ä–æ–π—Ç–µ –ø–∏—Å—å–º–æ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª.\n\n"
        "–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â—ë —Ä–∞–∑¬ª."
    ),
    "not_confirmed_new": (
        "‚ùó –Ø –Ω–µ –≤–∏–∂—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –ø–æ —ç—Ç–æ–º—É email.\n"
        "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –í—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –∏–º–µ–Ω–Ω–æ —ç—Ç–∏–º –∞–¥—Ä–µ—Å–æ–º –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É."
    ),
    "not_confirmed_unsubscribed": (
        "‚ùó –≠—Ç–æ—Ç email –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å: {email_status}.\n"
        "–ü–æ–¥–∞—Ä–æ–∫ –≤—ã–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º."
    ),
    "not_confirmed_other": (
        "‚ùó –°–µ–π—á–∞—Å –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ —É—Å–ª–æ–≤–∏—è–º.\n"
        "–°—Ç–∞—Ç—É—Å email: {email_status}\n"
        "–í —Å–ø–∏—Å–∫–µ: {in_list}, —Å—Ç–∞—Ç—É—Å –≤ —Å–ø–∏—Å–∫–µ: {list_status}"
    ),
    "already_rewarded": "‚úÖ –í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫.\n\n{reward_message}",
    "winner_message": (
        "–î–õ–Ø –¢–ï–•, –ö–¢–û –í–´–ò–ì–†–ê–õ\n\n"
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –Ω–∞—à—É —Ä–∞—Å—Å—ã–ª–∫—É! –î–µ–ª–∏–º—Å—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–º –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ üîΩ\n\n"
        "<code>{promo_code}</code>\n\n"
        "–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
        "1 –∫–æ–¥ = 1 –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—ã–π (1 –±–∏–ª–µ—Ç)\n\n"
        "–í –∫–∞—Å—Å–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∞–Ω—Å –∏ –º–µ—Å—Ç–∞ –≤ –∑–∞–ª–µ, –ø—Ä–æ–¥–∏–∫—Ç—É–π—Ç–µ –∫–∞—Å—Å–∏—Ä—É 10-—Ç–∏ –∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, –ø–æ–ª—É—á–∏—Ç–µ –±–∏–ª–µ—Ç.\n\n"
        "–ö–æ–¥ –î–ï–ô–°–¢–í–£–ï–¢:\n"
        "- –î–æ 1 –∏—é–Ω—è 2026 –≥–æ–¥–∞ (–∫—Ä–æ–º–µ 1-11 —è–Ω–≤–∞—Ä—è)\n"
        "- –í –ª—é–±–æ–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏\n"
        "- –í–æ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞—Ö —Å–µ—Ç–∏ –ö–ò–ù–û –û–ö–ö–û ¬´–°–∏–Ω–µ–º–∞ –ü–∞—Ä–∫¬ª –∏ ¬´–§–æ—Ä–º—É–ª–∞ –ö–∏–Ω–æ¬ª, –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–≤ –Ω–∞ —Å–∞–π—Ç–µ: "
        "<a href=\"https://kinoteatr.ru/\">https://kinoteatr.ru/</a> (–∫—Ä–æ–º–µ –∫-—Ç –†–æ–¥–∏–Ω–∞ –≤ –ö–∞–∑–∞–Ω–∏, —ç—Ç–æ —Ñ—Ä–∞–Ω—à–∏–∑–∞)\n"
        "- –ù–∞ —Å–µ–∞–Ω—Å—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ 2D –∏ 3D\n"
        "- –ù–∞ –ø–æ–∫–∞–∑—ã –≤ –æ–±—ã—á–Ω—ã—Ö –∑–∞–ª–∞—Ö, –∞ —Ç–∞–∫–∂–µ –≤ –∑–∞–ª–∞—Ö Dolby Atmos\n\n"
        "–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:\n"
        "–î–µ–π—Å—Ç–≤–∏–µ –∫–æ–¥–∞ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞:\n"
        "- –§–æ—Ä–º–∞—Ç—ã IMAX, IMAX Sapphire, 4D –∏ 4DX, –∑–∞–ª—ã –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ—Å—Ç–∏ (VIP, RELAX, JOLLY, Business, Premium), "
        "–∑–∞–ª—ã ¬´–ú—É–≤–∏–∫¬ª –∏ KIDS\n"
        "- –ù–∞ –ø–æ–∫–∞–∑—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –æ–ø–µ—Ä–Ω—ã—Ö —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π, –±–∞–ª–µ—Ç–∞, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, —Ñ–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤, "
        "—Ñ–∏–ª—å–º–æ–≤-–∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤ –∏ —Ç.–¥.)\n\n"
        "–ö–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.\n\n"
        "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–µ–∞–Ω—Å–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 3D –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –≤ –∫–∞—Å—Å–∞—Ö –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞—Ö."
    ),
    "non_winner_message": (
        "–î–õ–Ø –¢–ï–•, –ö–¢–û –ù–ï –í–´–ò–ì–†–ê–õ\n\n"
        "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –Ω–∞—à—É —Ä–∞—Å—Å—ã–ª–∫—É! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ä–∞–∑—ã–≥—Ä—ã–≤–∞–µ–º—ã–µ –Ω–∞–º–∏ –±–∏–ª–µ—Ç—ã –≤ –∫–∏–Ω–æ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –Ω–æ –º—ã –¥–∞—Ä–∏–º –≤–∞–º –±–æ–ª—å—à–æ–π "
        "<a href=\"{guide_link}\">–≥–∏–¥ –ø–æ –ø–µ—Ç–µ—Ä–±—É—Ä–≥—Å–∫–∏–º —Ç–µ–∞—Ç—Ä–∞–º</a>. "
        "–í –Ω—ë–º –º—ã —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∏, —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ —ç—Ç–æ–º —Å–µ–∑–æ–Ω–µ –Ω–∞ 20 –≥–æ—Ä–æ–¥—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ö ‚Äî –æ—Ç –∫—Ä—É–ø–Ω—ã—Ö –∏ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –¥–æ –∫–∞–º–µ—Ä–Ω—ã—Ö –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö."
    ),
}

TEXT_DESCRIPTIONS: dict[str, str] = {
    "welcome": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ—Å–ª–µ /start.",
    "check_again_prompt": "–û—Ç–≤–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â—ë —Ä–∞–∑¬ª.",
    "telegram_id_missing": "–û—à–∏–±–∫–∞, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID.",
    "invalid_email": "–û—Ç–≤–µ—Ç –Ω–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.",
    "unisender_unavailable": "–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Unisender.",
    "not_confirmed_invited": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ (status invited).",
    "not_confirmed_new": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞/–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ (status new –∏–ª–∏ None).",
    "not_confirmed_unsubscribed": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (unsubscribed/blocked/inactive).",
    "not_confirmed_other": "–û–±—â–∏–π —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å—ã –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç.",
    "already_rewarded": "–ü—Ä–µ—Ñ–∏–∫—Å, –µ—Å–ª–∏ –ø–æ–¥–∞—Ä–æ–∫ —É–∂–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω.",
    "winner_message": "–¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º.",
    "non_winner_message": "–¢–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤—ã–∏–≥—Ä–∞–ª.",
}


class TextService:
    @staticmethod
    async def get_text(session: AsyncSession, key: str) -> str:
        record = await BotTextRepo.get(session, key)
        if record:
            return record.value
        fallback = DEFAULT_TEXTS.get(key, "")
        if not fallback:
            log.warning("Missing text fallback", extra={"key": key})
        return fallback

    @staticmethod
    async def get_text_global(key: str) -> str:
        async with SessionMaker() as session:
            return await TextService.get_text(session, key)

    @staticmethod
    async def set_text(session: AsyncSession, key: str, value: str) -> None:
        await BotTextRepo.set(session, key, value)

    @staticmethod
    def list_keys() -> list[str]:
        return sorted(DEFAULT_TEXTS.keys())

    @staticmethod
    def render_default(key: str) -> str:
        return DEFAULT_TEXTS.get(key, "")

    @staticmethod
    def describe_keys() -> list[tuple[str, str]]:
        keys = TextService.list_keys()
        return [(key, TEXT_DESCRIPTIONS.get(key, "")) for key in keys]
